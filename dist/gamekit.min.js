/* Gamekit
 * =======
 * @license: CC BY-NC 3.0 (http://creativecommons.org/licenses/by-nc/3.0/)
 * @license: Request commercial licenses from hello@wearekiss.com
 * @author: Christian Engel <hello@wearekiss.com>
 * @updated: Sat Aug 17 2013
 */
!function(){"use strict";function a(){this.entities=[],this.visible=!0,this.alpha=1}function b(a){var d,m,n,o,p,q,r,s,t;if(f){for(window.requestAnimationFrame(b),g=a,p=e,s=c.width(),t=c.height(),(j||k)&&p.clearRect(h,i,j,k),d=l.length;d--;)m=l[d],m.finished?l.splice(d,1):m.update(a);for(q=c.layer.length-1,d=q+1;d--;)if(o=c.layer[q-d],o.visible&&o.alpha)for(r=o.entities.length-1,m=r+1;m--;)n=o.entities[r-m],p.globalAlpha=n.alpha*o.alpha,n.draw(p)}}var c,d,e;d=document.getElementsByTagName("canvas")[0],e=d.getContext("2d"),function(){for(var a=0,b=["webkit","moz"],c=0;c<b.length&&!window.requestAnimationFrame;++c)window.requestAnimationFrame=window[b[c]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[c]+"CancelAnimationFrame"]||window[b[c]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b){var c=(new Date).getTime(),d=Math.max(0,16-(c-a)),e=window.setTimeout(function(){b(c+d)},d);return a=c+d,e}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)})}(),window.gamekit=c={},c.Promise=function(a){this._promiseTarget=a||c},c.Promise.prototype={resolve:function(){var a,b;return"function"==typeof this._promiseSuccess?(a=this._promiseSuccess.apply(this._promiseTarget,arguments),a instanceof c.Promise?(b=this,a.then(function(){b._promiseChild.resolve.apply(b._promiseChild,arguments)},function(){b._promiseChild.reject.apply(b._promiseChild,arguments)})):this._promiseChild.resolve.apply(this._promiseChild,a),void 0):(this._promiseResolved=arguments,void 0)},reject:function(){var a,b;return"function"==typeof this._promiseError?(a=this._promiseError.apply(this._promiseTarget,arguments),a instanceof c.Promise?(b=this,a.then(function(){b._promiseChild.resolve.apply(b._promiseChild,arguments)},function(){b._promiseChild.reject.apply(b._promiseChild,arguments)})):this._promiseChild.reject.apply(this._promiseChild,a),void 0):(this._promiseRejected=arguments,void 0)},then:function(a,b){return this._promiseSuccess=a,this._promiseError=b,this._promiseChild=new c.Promise(this._promiseTarget),void 0!==this._promiseResolved&&this._promiseChild.resolve.apply(this._promiseChild,this._promiseResolved),void 0!==this._promiseRejected&&this._promiseChild.reject.apply(this._promiseChild,this._promiseRejected),this._promiseChild}},c.all=function(){function a(){d++,d===arguments.length&&b.resolve()}var b,d,e;for(b=new c.Promise,d=0,e=0;e<arguments.length;e++)arguments[e].then(a,b.reject);return b},c.m={},c.moduleFolder="lib/game/",c.defineModule=function(a,b){c.m[a]=b()},c.fetchModules=function(a){function b(){h++,h===g.length&&f.resolve()}function d(){f.reject()}var e,f,g,h,i;f=new c.Promise,g=[],h=0,"string"==typeof a&&(a=[a]);for(e in a)void 0===c.m[a[e]]&&g.push(c.moduleFolder+a[e]+".js");if(g.length)for(e in g)i=document.createElement("script"),i.onload=b,i.onerror=d,document.head.appendChild(i),i.src=g[e],g[e]=i;else f.resolve();return f},c.a={},c.assetFolder="lib/assets/",c.getJSON=function(a){var b,d;return b=new c.Promise,d=new XMLHttpRequest,d.onload=function(){var a;try{a=JSON.parse(d.responseText),b.resolve(a)}catch(c){b.reject(c)}},d.onerror=b.reject,d.open("get",a,!0),d.send(),b},c.fetchAssets=function(a){function b(){var a,b;return a=this.src.match(j),a&&(c.a[this.assetKey]=new c.SpriteMap(c.a[this.assetKey],parseInt(a[1],10),parseInt(a[2],10)),h++,h===g.length&&e.resolve()),(a=this.src.match(k))?(a=this.src.split("."),a.pop(),a=a.join(".")+".json",b=this,c.getJSON(a).then(function(a){c.a[b.assetKey]=new c.SpriteAtlas(c.a[b.assetKey],a),h++,h===g.length&&e.resolve()}),void 0):(h++,h===g.length&&e.resolve(),void 0)}function d(){e.reject()}var e,f,g,h,i,j,k;if(e=new c.Promise,g=[],h=0,j=/\.smap\.(\d+)x(\d+)\./,k=/\.atlas\./,"string"==typeof a){if(".json"===a.substr(-5))return c.getJSON(c.assetFolder+a).then(c.fetchAssets).then(function(){e.resolve()},function(){e.reject()}),e;a=[a]}for(f in a){if(a[f]=a[f].split(":"),2!==a[f].length)return e.reject(),e;void 0===c.a[a[f][0]]&&(i=new Image,i.onload=b,i.onerror=d,i.assetKey=a[f][0],c.a[a[f][0]]=i,g.push(a[f]))}if(g.length)for(f in g)c.a[g[f][0]].src=c.assetFolder+g[f][1];else e.resolve();return e},c.SpriteMap=function(){},c.SpriteAtlas=function(){},a.prototype={attach:function(a){this.entities.push(a)}},c.layer=[new a],c.createLayer=function(){var b;return b=new a,c.layer.push(b),b};var f,g;c.start=function(){f=!0,window.requestAnimationFrame(b)},c.stop=function(){f=!1},c.width=function(){return d.width},c.height=function(){return d.height};var h,i,j,k;c.clearCanvas=function(a,b,d,e){h=a||0,i=b||0,j=d||c.width(),k=e||c.height()};var l;c.renderDebugObjects=!1,l=[],c.Sprite=function(a){this.x=0,this.y=0,this.w=a.width,this.h=a.height,this.originX=0,this.originY=0,this.rotation=0,this.scaleX=1,this.scaleY=1,this.alpha=1,this.stretch=!1,this.asset=a},c.Sprite.prototype={draw:function(a){var b,d,e,f;return e=this.originX,f=this.originY,b=this.w,d=this.h,a.save(),a.translate(this.x,this.y),this.rotation&&a.rotate(this.rotation*Math.PI/360),a.scale(this.scaleX,this.scaleY),this.stretch||b===this.asset.width&&d===this.asset.height?(a.drawImage(this.asset,-e,-f,b,d),c.renderDebugObjects&&(a.beginPath(),a.strokeStyle="#0ff",a.strokeRect(-e,-f,b,d),a.stroke(),a.fillStyle="#f0f",a.beginPath(),a.arc(0,0,2,0,365),a.fill()),a.restore(),void 0):(this.pattern||(this.pattern=a.createPattern(this.asset,"repeat")),a.rect(-e,-f,b,d),a.fillStyle=this.pattern,a.fill(),a.restore(),void 0)},centerOrigin:function(){return this.changeOrigin(this.w/2,this.h/2),this},changeOrigin:function(a,b){var c,d;return c=this.originX,d=this.originY,this.x+=-c+a,this.y+=-d+b,this.originX=a,this.originY=b,this},tween:function(a,b){var d,e,f,h,i,j,k,m,n;d=g,e=d+b,h=new c.Promise,i=this,j={},k={},m=0;for(n in a)this.hasOwnProperty(n)&&!isNaN(parseFloat(this[n]))&&isFinite(this[n])&&(j[n]=this[n],k[n]=a[n]-this[n],m++);return m?(f={finished:!1,update:function(a){var c;void 0===d&&(d=a,e=d+b),c=1-1/((e-d)/(e-a)),c>=1&&(c=1);for(n in j)i[n]=j[n]+k[n]*c;return 1===c?(f.finished=!0,h.resolve(),void 0):void 0}},l.push(f),h):(h.reject(),h)},prepareTween:function(a,b){var c;return c=this,function(){return c.tween(a,b)}}},c.Group=function(){this.x=0,this.y=0,this.rotation=0,this.alpha=1,this.scaleX=1,this.scaleY=1,this.entities=[]},c.Group.prototype={getBoundaries:function(){var a,b,c,d,e,f;if(a=Number.POSITIVE_INFINITY,b=Number.POSITIVE_INFINITY,c=0,d=0,!this.entities.length)return{x:this.x,y:this.y,w:0,h:0};for(e in this.entities)f=this.entities[e],void 0!==f.originX?(a=Math.min(a,f.x-f.originX),b=Math.min(b,f.y-f.originY),c=Math.max(c,f.x+f.w-f.originX),d=Math.max(d,f.y+f.h-f.originY)):(a=Math.min(a,f.x),b=Math.min(b,f.y),c=Math.max(c,f.x+f.w),d=Math.max(d,f.y+f.h));return c-=a,d-=b,{x:a,y:b,w:c,h:d}},attach:function(a){this.entities.push(a)},draw:function(a){var b,d,e;a.save(),a.translate(this.x,this.y),a.rotate(this.rotation*Math.PI/360),a.scale(this.scaleX,this.scaleY),b=a.globalAlpha;for(d in this.entities)e=this.entities[d],a.globalAlpha=b*e.alpha,e.draw(a);if(c.renderDebugObjects){var f;f=this.getBoundaries(),a.beginPath(),a.strokeStyle="#0f0",a.strokeRect(f.x,f.y,f.w,f.h),a.stroke(),a.fillStyle="#ff0",a.beginPath(),a.arc(0,0,2,0,365),a.fill()}a.restore()},changeOrigin:function(a,b){var c,d,e,f;c=this.x,d=this.y;for(e in this.entities)f=this.entities[e],f.x-=-c+a,f.y-=-d+b;return this.x=a,this.y=b,this}},c.Group.prototype.tween=c.Sprite.prototype.tween,c.Group.prototype.prepareTween=c.Sprite.prototype.prepareTween,setTimeout(function(){c.fetchModules("main")},0)}();